import{a as nt,b as rt,c as _}from"./chunk-ODTFD3QQ.js";import"./chunk-TVFTUAXU.js";import{B,j as Ft,l as Dt,m as Mt,o as Pt,p as Et,t as W,u as It,v as Nt,z as At}from"./chunk-QGEUABJK.js";import"./chunk-R5IEJ2W2.js";import"./chunk-OHBNF7H4.js";import{g as Ct}from"./chunk-BLSNVWGO.js";import{a as _t}from"./chunk-7HYQIZLR.js";import{d as Tt,e as wt}from"./chunk-53BCAK53.js";import{d as at}from"./chunk-NELNUKEX.js";import{d as vt,e as xt}from"./chunk-KZGPV3OV.js";import"./chunk-MROZGMZP.js";import"./chunk-6MWK2YGG.js";import"./chunk-S23T3VNK.js";import"./chunk-ZSZR532A.js";import{g as j,k as x}from"./chunk-56NTXRTG.js";import{b as lt,d as S,f as st,g as G,h as mt,j as ct,l as pt,m as dt,o as ut,p as ft,q as ht,r as gt,v as yt,w as St,x as bt}from"./chunk-3IAGLYRS.js";import{m as z}from"./chunk-DIBFAAWP.js";import{Ab as y,Bb as h,C as w,Lb as m,Lc as Z,M as F,Nb as g,Nc as tt,Oc as et,Ra as l,Rc as it,S as J,Sa as p,Sb as N,Sc as L,T as D,Tb as A,Tc as ot,Uc as v,Vb as H,X as K,ba as M,ca as P,d as $,dc as f,ec as q,fc as b,gb as T,ib as s,j as O,la as E,ma as I,ob as Q,r as Y,tb as r,ub as n,vb as u,wb as U,xb as X,zb as R}from"./chunk-UISEBZIM.js";function Lt(o,d){return d.transform(o,"yyyy-MM-dd HH:mm:ss")}var k=(()=>{class o{constructor(t){this.apiService=t,this.sales=[],this.sales$=new O(this.sales),this.total=0,this.total$=new O(this.total)}callGetList(t=10,e=1,i=""){let a=`sales?limit=${t}&page=${e}`;return i&&(a+=`&search=${i}`),this.apiService.get(a).pipe(w(600),Y(c=>{this.updateSales(c.data),this.updateTotalSales(c.paginate.total)}))}getList(){return this.sales$.asObservable()}getTotal(){return this.total$.asObservable()}create(t){return this.apiService.post("sales",t).pipe(F(()=>this.callGetList()))}delete(t){return this.apiService.delete(`sales/${t}`).pipe(F(()=>this.callGetList()))}edit(t,e){return this.apiService.patch(`sales/${t}`,e).pipe(F(()=>this.callGetList()))}getOne(t){return this.apiService.get(`sales/${t}`)}updateSales(t){this.sales=t,this.sales$.next(this.sales)}updateTotalSales(t){this.total=t,this.total$.next(this.total)}static{this.\u0275fac=function(e){return new(e||o)(K(at))}}static{this.\u0275prov=J({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();function qt(o,d){if(o&1&&(U(0),r(1,"tr",27)(2,"td",28),m(3),n(),r(4,"td",29)(5,"div",30),m(6),n()(),r(7,"td",29),u(8,"input",31),n(),r(9,"td",32),m(10),f(11,"number"),n()(),X()),o&2){let t,e,i,a=d.$implicit,c=d.index;l(),s("formGroupName",c),l(2),g(" ",(t=a.get("quantity"))==null?null:t.value," "),l(3),g(" ",(e=a.get("description_full"))==null?null:e.value," "),l(4),g(" ",b(11,4,(i=a.get("subtotal"))==null?null:i.value,"1.2-2")," ")}}function zt(o,d){if(o&1){let t=R();r(0,"div",33),u(1,"p-dropdown",34),r(2,"div",35)(3,"span",36),m(4,"S/"),n(),u(5,"input",37),n(),r(6,"button",38),y("click",function(){let i=E(t).index,a=h(2);return I(a.removePayment(i))}),n()()}if(o&2){let t=d.index,e=h(2);s("formGroupName",t),l(),s("options",e.paymentMethodsList),l(5),s("disabled",e.paymentsControls.length===1)}}function Wt(o,d){if(o&1&&(r(0,"span",39),m(1),f(2,"number"),n()),o&2){let t=h(2);l(),g(" Falta: S/ ",b(2,1,t.calculatedTotal-t.calculatedPayments,"1.2-2")," ")}}function Yt(o,d){if(o&1&&(r(0,"span",39),m(1),f(2,"number"),n()),o&2){let t=h(2);l(),g(" Sobran: S/ ",b(2,1,t.calculatedPayments-t.calculatedTotal,"1.2-2")," ")}}function Jt(o,d){o&1&&(r(0,"span",40),u(1,"i",41),m(2," Correcto "),n())}function Kt(o,d){if(o&1){let t=R();r(0,"form",1),y("ngSubmit",function(){E(t);let i=h();return I(i.buttonSaveSale())}),r(1,"div",2)(2,"div",3),u(3,"app-input-date",4),n(),r(4,"div",3)(5,"span",5),m(6,"Productos"),n(),r(7,"div",6)(8,"table",7)(9,"thead",8)(10,"tr")(11,"th",9),m(12,"Cant."),n(),r(13,"th",9),m(14,"Desc."),n(),r(15,"th",10),m(16,"Precio"),n(),r(17,"th",11),m(18,"Sub."),n()()(),r(19,"tbody"),T(20,qt,12,7,"ng-container",12),n(),r(21,"tfoot",13)(22,"tr")(23,"td",14),m(24," Total Venta "),n(),r(25,"td",15),m(26),f(27,"number"),n()()()()()(),r(28,"div",16)(29,"div",17)(30,"span",18),m(31,"Pagos"),n(),r(32,"button",19),y("click",function(){E(t);let i=h();return I(i.addPaymentRow())}),n()(),r(33,"div",20),T(34,zt,7,3,"div",21),n(),r(35,"div",22)(36,"span",23),m(37),f(38,"number"),n(),T(39,Wt,3,4,"span",24)(40,Yt,3,4,"span",24)(41,Jt,3,0,"span",25),n()(),u(42,"button",26),n()()}if(o&2){let t=h();s("formGroup",t.form),l(20),s("ngForOf",t.itemsControls),l(6),g(" ",b(27,10,t.calculatedTotal,"1.2-2")," "),l(8),s("ngForOf",t.paymentsControls),l(),s("ngClass",t.calculatedTotal-t.calculatedPayments>.1?"bg-red-50 text-red-600":"bg-green-50 text-green-700"),l(2),g("Total Pagado: S/ ",b(38,13,t.calculatedPayments,"1.2-2"),""),l(2),s("ngIf",t.calculatedTotal-t.calculatedPayments>.1),l(),s("ngIf",t.calculatedTotal-t.calculatedPayments<-.1),l(),s("ngIf",t.calculatedTotal-t.calculatedPayments<=.1&&t.calculatedTotal-t.calculatedPayments>=-.1),l(),s("disabled",!t.isFormValid)}}var Gt=(()=>{class o{constructor(t,e,i,a,c){this.formBuilder=t,this.salesService=e,this.dynamicDialogRef=i,this.dynamicDialogConfig=a,this.datePipe=c,this.form=this.formBuilder.group({creationTime:[new Date,S.nullValidator],items:this.formBuilder.array([]),payments:this.formBuilder.array([])}),this.calculatedTotal=0,this.calculatedPayments=0,this.paymentMethodsList=["CASH","YAPE","CARD"]}ngOnInit(){if(this.dynamicDialogConfig.data.id){let t=this.dynamicDialogConfig.data.id;this.salesService.getOne(t).subscribe(e=>{e.datetime_iso&&this.form.patchValue({creationTime:new Date(e.datetime_iso)}),this.initItems(e.items),this.initPayments(e.payments),this.recalculateTotals()})}}initItems(t){let e=this.form.get("items");e.clear(),t.forEach(i=>{let a=this.formBuilder.group({id:[i.id],product_name:[i.product_name],description_full:[i.description_full],quantity:[i.quantity],unit_price:[i.unit_price,[S.required,S.min(0)]],subtotal:[i.subtotal]});a.get("unit_price")?.valueChanges.subscribe(()=>{let c=a.get("quantity")?.value,C=a.get("unit_price")?.value;a.patchValue({subtotal:c*C},{emitEvent:!1}),this.recalculateTotals()}),e.push(a)})}initPayments(t){if(this.form.get("payments").clear(),!t||t.length===0){this.addPaymentRow(this.calculatedTotal,"CASH");return}t.forEach(i=>{this.addPaymentRow(i.amount,i.method)})}addPaymentRow(t=0,e="CASH"){let i=this.form.get("payments"),a=this.formBuilder.group({method:[e,S.required],amount:[t,[S.required,S.min(0)]]});a.get("amount")?.valueChanges.subscribe(()=>this.recalculateTotals()),i.push(a),this.recalculateTotals()}removePayment(t){this.form.get("payments").removeAt(t),this.recalculateTotals()}recalculateTotals(){let t=this.form.get("items").controls;this.calculatedTotal=t.reduce((i,a)=>i+(a.get("subtotal")?.value||0),0);let e=this.form.get("payments").controls;this.calculatedPayments=e.reduce((i,a)=>i+(a.get("amount")?.value||0),0)}get itemsControls(){return this.form.get("items").controls}get paymentsControls(){return this.form.get("payments").controls}get isFormValid(){let t=Math.abs(this.calculatedTotal-this.calculatedPayments);return this.form.valid&&t<.1}buttonSaveSale(){if(this.isFormValid){let t=this.form.getRawValue(),e=this.dynamicDialogConfig.data.id,i={id:e,code:this.dynamicDialogConfig.data.code,total:this.calculatedTotal,status:this.dynamicDialogConfig.data.status,creationTime:Lt(t.creationTime,this.datePipe),items:t.items.map(a=>({id:a.id,unit_price:a.unit_price})),payments:t.payments.map(a=>({method:a.method,amount:a.amount}))};this.salesService.edit(e,i).subscribe({next:()=>this.dynamicDialogRef.close(!0),error:()=>{}})}}static{this.\u0275fac=function(e){return new(e||o)(p(yt),p(k),p(rt),p(nt),p(L))}}static{this.\u0275cmp=M({type:o,selectors:[["app-form"]],standalone:!0,features:[N([_,x,L]),A],decls:1,vars:1,consts:[[3,"formGroup"],[3,"ngSubmit","formGroup"],[1,"p-fluid","p-formgrid","grid"],[1,"col-12"],["label","Fecha","for","creationTime","controlName","creationTime"],[1,"block","text-500","font-bold","mb-2","text-sm","uppercase"],["formArrayName","items",1,"border-1","border-200","border-round-xl","overflow-hidden"],[1,"w-full","text-sm"],[1,"surface-100","border-bottom-1","border-200"],[1,"p-2","text-left"],[1,"p-2","text-right","w-6rem"],[1,"p-2","text-right"],[4,"ngFor","ngForOf"],[1,"surface-50"],["colspan","3",1,"p-2","text-right","font-bold"],[1,"p-2","text-right","font-black","text-indigo-700"],[1,"col-12","mb-3"],[1,"flex","justify-content-between","align-items-center","mb-2"],[1,"text-500","font-bold","text-sm","uppercase"],["type","button","pButton","","icon","pi pi-plus","label","Agregar Pago",1,"p-button-text","p-button-sm","py-1",3,"click"],["formArrayName","payments",1,"flex","flex-column","gap-2"],["class","flex gap-2 align-items-center",3,"formGroupName",4,"ngFor","ngForOf"],[1,"flex","justify-content-between","mt-2","p-2","border-round",3,"ngClass"],[1,"text-xs","font-bold","uppercase"],["class","text-xs font-bold",4,"ngIf"],["class","text-xs font-bold flex align-items-center gap-1",4,"ngIf"],["type","submit","pButton","","label","Guardar Todo","autofocus","",1,"mt-4","w-full","p-button-primary","font-bold","shadow-2",3,"disabled"],[1,"border-bottom-1","surface-border",3,"formGroupName"],[1,"p-2","text-center","font-bold"],[1,"p-2"],[1,"font-bold","text-xs"],["type","number","pInputText","","formControlName","unit_price",1,"w-full","text-right","p-1","h-2rem","text-sm"],[1,"p-2","text-right","font-bold"],[1,"flex","gap-2","align-items-center",3,"formGroupName"],["formControlName","method","styleClass","w-full text-sm",1,"w-full",3,"options"],[1,"p-inputgroup","w-8rem"],[1,"p-inputgroup-addon","py-1","px-2","text-xs"],["type","number","pInputText","","formControlName","amount",1,"text-right","p-1","text-sm","font-bold"],["type","button","pButton","","icon","pi pi-trash",1,"p-button-danger","p-button-text","p-button-rounded",3,"click","disabled"],[1,"text-xs","font-bold"],[1,"text-xs","font-bold","flex","align-items-center","gap-1"],[1,"pi","pi-check-circle"]],template:function(e,i){e&1&&T(0,Kt,43,16,"form",0),e&2&&Q(0,i.form?0:-1)},dependencies:[v,Z,tt,et,ot,St,pt,lt,dt,st,G,bt,ut,gt,ft,ht,B,_t,Ct,Tt,Ft]})}}return o})();var Qt=()=>[],Ut=()=>[10,20,50],Bt=(()=>{class o{constructor(t,e,i,a,c){this.dialogService=t,this.messageService=e,this.confirmationService=i,this.loadingService=a,this.salesService=c,this.columns=[],this.limit=10,this.page=1,this.search="",this.callToAction=[{type:"button",size:"small",icon:"pi pi-pencil",outlined:!0,pTooltip:"Editar",tooltipPosition:"bottom",click:C=>this.buttonEditSale(C.id)},{type:"button",size:"small",icon:"pi pi-trash",outlined:!0,pTooltip:"Eliminar",tooltipPosition:"bottom",click:(C,kt)=>this.buttonDeleteSale(C.id,kt)}],this.formGroup=new mt({search:new ct(null)})}ngOnInit(){this.columns=[{header:"C\xF3digo",field:"code",clickable:!1,image:!1,money:!1},{header:"Fecha",field:"date",clickable:!1,image:!1,money:!1},{header:"Cliente",field:"customer",clickable:!1,image:!1,money:!1},{header:"Total",field:"total",clickable:!1,image:!1,money:!1},{header:"Estado",field:"status",clickable:!1,image:!1,money:!1},{header:"Acci\xF3n",field:"button",clickable:!1,image:!1,money:!1}],this.getSales(this.limit,this.page,this.search),this.formGroup.get("search")?.valueChanges.pipe(w(600)).subscribe(t=>{this.search=t||"",this.loadingService.sendLoadingState(!0),this.getSales(this.limit,this.page,this.search)})}ngOnDestroy(){this.saleModal&&this.saleModal.close()}clearFilter(){this.search="",this.loadingService.sendLoadingState(!0),this.formGroup.get("search")?.setValue("")}getSales(){return $(this,arguments,function*(t=this.limit,e=this.page,i=this.search){this.updatePage(e),this.salesService.callGetList(t,e,i).subscribe(),setTimeout(()=>{this.loadingService.sendLoadingState(!1)},600)})}onPageSelected(t){return $(this,null,function*(){this.updatePage((t.page??0)+1),this.getSales(t.rows,this.page)})}get sales(){return this.salesService.getList()}get total(){return this.salesService.getTotal()}buttonEditSale(t){this.saleModal=this.dialogService.open(Gt,{data:{id:t},header:"Detalle venta",styleClass:"dialog-custom-form"}),this.saleModal.onClose.subscribe({next:e=>{e&&e?.success?W(this.messageService,"Detalle actualizado."):e?.error&&It(this.messageService,e?.error)}})}buttonDeleteSale(t,e){this.confirmationService.confirm({target:e.target,message:"Deseas cancelar esta venta?",header:"Eliminar usuario",icon:"pi pi-info-circle",acceptButtonStyleClass:"p-button-danger p-button-text",rejectButtonStyleClass:"p-button-text p-button-text",acceptIcon:"none",rejectIcon:"none",acceptLabel:"S\xED",rejectLabel:"No",accept:()=>{this.salesService.delete(t).subscribe(()=>{W(this.messageService,"La venta ha sido cancelada")})},reject:()=>{Nt(this.messageService,"No se realiz\xF3 ninguna acci\xF3n.")}})}updatePage(t){this.page=t}static{this.\u0275fac=function(e){return new(e||o)(p(_),p(x),p(j),p(Pt),p(k))}}static{this.\u0275cmp=M({type:o,selectors:[["app-list"]],standalone:!0,features:[N([j,x,_]),A],decls:10,vars:15,consts:[[1,"card"],[1,"flex","justify-content-between","align-items-center","mt-3","gap-3"],["controlName","search",1,"w-full","md:w-3",3,"clearFilter","formGroup"],[3,"outlined"],[1,"pi","pi-plus",2,"font-size","1rem"],[3,"paginateSelected","data","columns","callToAction","cellToAction","total","limit","rowsPerPageOptions"]],template:function(e,i){if(e&1&&(r(0,"div",0)(1,"div",1)(2,"app-input-search",2),y("clearFilter",function(){return i.clearFilter()}),n(),r(3,"p-button",3),u(4,"i",4),n()(),r(5,"app-table-pagination",5),f(6,"async"),f(7,"async"),y("paginateSelected",function(c){return i.onPageSelected(c)}),n(),u(8,"p-toast")(9,"p-confirmDialog"),n()),e&2){let a,c;l(2),s("formGroup",i.formGroup),l(),s("outlined",!0),l(2),s("data",(a=q(6,9,i.sales))!==null&&a!==void 0?a:H(13,Qt))("columns",i.columns)("callToAction",i.callToAction)("cellToAction",i.cellToAction)("total",(c=q(7,11,i.total))!==null&&c!==void 0?c:0)("limit",i.limit)("rowsPerPageOptions",H(14,Ut))}},dependencies:[v,it,B,wt,G,Et,At,xt,vt,Mt,Dt],styles:[".dialog-custom-form{width:30%!important;height:55rem!important}  .dialog-custom-assign{width:15%!important;height:35rem!important}@media (max-width: 480px){  .dialog-custom-form{width:70%!important;height:35rem!important}  .dialog-custom-assign{width:70%!important;height:35rem!important}}"]})}}return o})();var Xt=[{path:"",component:Bt},{path:"",pathMatch:"full",redirectTo:"sales"}],Vt=(()=>{class o{static{this.\u0275fac=function(e){return new(e||o)}}static{this.\u0275mod=P({type:o})}static{this.\u0275inj=D({imports:[z.forChild(Xt),z]})}}return o})();var je=(()=>{class o{static{this.\u0275fac=function(e){return new(e||o)}}static{this.\u0275mod=P({type:o})}static{this.\u0275inj=D({imports:[v,Vt]})}}return o})();export{je as SalesListModule};

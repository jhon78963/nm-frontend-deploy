import{d as m}from"./chunk-NELNUKEX.js";import{S as u,Y as p,a as l,ab as r,b as d,d as c,q as n,wc as h}from"./chunk-UISEBZIM.js";var k=(()=>{class i{constructor(){this.apiService=p(m),this.cart=r([]),this.currentCustomer=r(null),this.modalState=r({isOpen:!1,product:null,isEditing:!1}),this.toastMessage=r(null),this.paymentMethod=r("EFECTIVO"),this.isLoading=r(!1),this.grandTotal=h(()=>this.cart().reduce((t,e)=>t+e.total,0)),this.totalItems=h(()=>this.cart().reduce((t,e)=>t+e.quantity,0))}searchProductBySku(t){return c(this,null,function*(){this.isLoading.set(!0);try{return yield n(this.apiService.get(`pos/products?sku=${t}`))}catch(e){console.error("Error buscando producto:",e),this.showToast("Producto no encontrado");return}finally{this.isLoading.set(!1)}})}searchCustomerByDni(t){return c(this,null,function*(){this.isLoading.set(!0);try{let e=yield n(this.apiService.get(`pos/customers?dni=${t}`));return e?(this.currentCustomer.set(e),this.showToast("Cliente encontrado"),!0):!1}catch(e){return console.error("Error buscando cliente:",e),this.showToast("Cliente no encontrado / Error API"),!1}finally{this.isLoading.set(!1)}})}processCheckoutWithPayments(t){return c(this,null,function*(){if(this.cart().length===0)return this.showToast("El carrito est\xE1 vac\xEDo");this.isLoading.set(!0);let e={customer:{id:this.currentCustomer()?.id},total:this.grandTotal(),payments:t,items:this.cart().map(s=>({name:s.name,quantity:s.quantity,unitPrice:s.unitPrice,total:s.total,size:s.size,color:{product_size_id:s.color.product_size_id,color_id:s.color.color_id,colorName:s.color.colorName,hex:s.color.hex,stock:s.color.stock}}))};try{let s=yield n(this.apiService.post("pos/checkout",e));s.success&&(this.showToast(`Venta ${s.sale_id} Exitosa!`),this.printTicket(s.sale_id),this.clearCart())}catch(s){this.showToast("Error al procesar venta"),console.error(s)}finally{this.isLoading.set(!1)}})}processCheckout(){return c(this,null,function*(){if(this.cart().length===0)return this.showToast("El carrito est\xE1 vac\xEDo");let t=this.paymentMethod(),e="CASH";t==="YAPE/PLIN"&&(e="YAPE"),t==="TRANSFERENCIA"&&(e="CARD");let s=[{method:e,amount:this.grandTotal()}];return this.processCheckoutWithPayments(s)})}addItem(t){this.cart.update(e=>[...e,t]),this.showToast("Producto Agregado")}updateItem(t){this.cart.update(e=>e.map(s=>s.cartId===t.cartId?t:s)),this.showToast("\xCDtem Actualizado")}removeItem(t){this.cart.update(e=>e.filter(s=>s.cartId!==t))}clearCart(){this.cart.set([]),this.currentCustomer.set(null),this.paymentMethod.set("EFECTIVO")}updateQuantity(t,e){this.cart.update(s=>s.map(o=>{if(o.cartId===t){let a=o.quantity+e;return a<=0?o:a>o.color.stock?(this.showToast(`Stock m\xE1x: ${o.color.stock}`),o):d(l({},o),{quantity:a,total:a*o.unitPrice})}return o}))}openAddModal(t){this.modalState.set({isOpen:!0,product:t,isEditing:!1})}openEditModal(t){this.searchProductBySku(t.sku).then(e=>{e&&this.modalState.set({isOpen:!0,product:e,isEditing:!0,editingCartItem:t})})}closeModal(){this.modalState.set({isOpen:!1,product:null,isEditing:!1})}showToast(t){this.toastMessage.set(t),setTimeout(()=>this.toastMessage.set(null),2500)}setPaymentMethod(t){this.paymentMethod.set(t)}printTicket(t){console.log("Imprimiendo ticket para venta ID:",t);let s=`${this.apiService.BASE_URL.replace(/\/api\/?$/,"")}/pos/sales/${t}/ticket`,o=document.createElement("iframe");o.style.display="none",o.src=s,document.body.appendChild(o),o.onload=()=>{try{o.contentWindow?.print()}catch(a){console.error(a)}setTimeout(()=>{document.body.removeChild(o)},5e3)}}static{this.\u0275fac=function(e){return new(e||i)}}static{this.\u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{k as a};
